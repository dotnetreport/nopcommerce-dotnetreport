function pagerViewModel(e){e=e||{};var r=this;r.pageSize=ko.observable(e.pageSize||30),r.pages=ko.observable(e.pages||1),r.currentPage=ko.observable(e.currentPage||1),r.pauseNavigation=ko.observable(!1),r.totalRecords=ko.observable(0),r.sortColumn=ko.observable(),r.sortDescending=ko.observable(),r.isFirstPage=ko.computed(function(){return 1==this.currentPage()},r),r.isLastPage=ko.computed(function(){return this.currentPage()==this.pages()},r),r.currentPage.subscribe(function(e){e>r.pages()&&r.currentPage(0==r.pages()?1:r.pages()),e<1&&r.currentPage(1)}),r.previous=function(){r.pauseNavigation()||r.isFirstPage()||isNaN(r.currentPage())||r.currentPage(Number(r.currentPage())-1)},r.next=function(){r.pauseNavigation()||r.isLastPage()||isNaN(r.currentPage())||r.currentPage(Number(r.currentPage())+1)},r.first=function(){r.pauseNavigation()||r.currentPage(1)},r.last=function(){r.pauseNavigation()||r.currentPage(r.pages())},r.changeSort=function(e){r.sortColumn()==e?r.sortDescending(!r.sortDescending()):r.sortDescending(!1),r.sortColumn(e),1!=r.currentPage()&&r.currentPage(1)}}function formulaFieldViewModel(e){e=e||{};var r=this;r.fieldId=ko.observable(e.fieldId),r.isParenthesesStart=ko.observable(e.isParenthesesStart),r.isParenthesesEnd=ko.observable(e.isParenthesesEnd),r.formulaOperation=ko.observable(e.formulaOperation),r.isConstantValue=ko.observable(!!e.constantValue),r.constantValue=ko.observable(e.constantValue)}function scheduleBuilder(){var r=this;r.options=["day","week","month","year"],r.showAtTime=ko.observable(!0),r.showDays=ko.observable(!1),r.showMonths=ko.observable(!1),r.showDates=ko.observable(!1),r.selectedOption=ko.observable("day"),r.selectedDays=ko.observableArray([]),r.selectedMonths=ko.observableArray([]),r.selectedDates=ko.observableArray([]),r.selectedHour=ko.observable("12"),r.selectedMinute=ko.observable("00"),r.selectedAmPm=ko.observable("PM"),r.days=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],r.months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],r.dates=[],r.hours=[],r.minutes=["00","15","30","45"];for(var e=1;e<=31;e++)r.dates.push(e);for(e=1;e<=12;e++)r.hours.push(e);r.hasSchedule=ko.observable(!1),r.emailTo=ko.observable(""),r.selectedOption.subscribe(function(e){switch(r.selectedDays([]),r.selectedMonths([]),r.selectedDates([]),e){case"day":r.showDays(!1),r.showDates(!1),r.showMonths(!1);break;case"week":r.showDays(!0),r.showDates(!1),r.showMonths(!1);break;case"month":r.showDays(!1),r.showDates(!0),r.showMonths(!1);break;case"year":r.showDays(!1),r.showDates(!0),r.showMonths(!0)}}),r.toJs=function(){return r.hasSchedule()?{SelectedOption:r.selectedOption(),SelectedDays:r.selectedDays().join(","),SelectedMonths:r.selectedMonths().join(","),SelectedDates:r.selectedDates().join(","),SelectedHour:r.selectedHour(),SelectedMinute:r.selectedMinute(),SelectedAmPm:r.selectedAmPm(),EmailTo:r.emailTo()}:null},r.fromJs=function(e){r.hasSchedule(!!e),e=e||{SelectedOption:"day",SelectedDays:"",SelectedMonths:"",SelectedDates:""},r.selectedOption(e.SelectedOption),r.selectedDays(_.map(e.SelectedDays.split(","),function(e){return parseInt(e)})),r.selectedMonths(_.map(e.SelectedMonths.split(","),function(e){return parseInt(e)})),r.selectedDates(_.map(e.SelectedDates.split(","),function(e){return parseInt(e)})),r.selectedHour(e.SelectedHour||"12"),r.selectedMinute(e.SelectedMinute||"00"),r.selectedAmPm(e.SelectedAmPm||"PM"),r.emailTo(e.EmailTo||"")},r.clear=function(){r.fromJs(null)}}function filterGroupViewModel(a){a=a||{};var s=this;s.isRoot=!0===a.isRoot,s.AndOr=ko.observable(a.AndOr||" AND "),s.Filters=ko.observableArray([]),s.FilterGroups=ko.observableArray([]),s.AddFilterGroup=function(e){var r=new filterGroupViewModel({parent:a.parent,AndOr:e.AndOr,options:a.options});return s.FilterGroups.push(r),r},s.RemoveFilterGroup=function(e){s.FilterGroups.remove(e)},s.AddFilter=function(e,r){e=e||{};var o=ko.observableArray([]);e.Value1&&o.push({id:e.Value1,text:e.Value1}),e.Value2&&o.push({id:e.Value2,text:e.Value2});var t=ko.observable();t.subscribe(function(e){e&&e.hasForeignKey&&ajaxcall({url:a.options.apiUrl,data:{method:"/ReportApi/GetLookupList",model:JSON.stringify({fieldId:e.fieldId})}}).done(function(e){e.d&&(e=e.d),ajaxcall({type:"POST",url:a.options.lookupListUrl,data:JSON.stringify({lookupSql:e.sql,connectKey:e.connectKey})}).done(function(e){e.d&&(e=e.d),o(e)})})}),e.FieldId&&t(a.parent.FindField(e.FieldId)),s.Filters.push({AndOr:ko.observable(r?" AND ":e.AndOr),Field:t,Operator:ko.observable(e.Operator),Value:ko.observable(e.Value1),Value2:ko.observable(e.Value2),LookupList:o,Apply:ko.observable(null==e.Apply||e.Apply),IsFilterOnFly:!0===r})},s.RemoveFilter=function(e){s.Filters.remove(e)}}var manageAccess=function(e){return{clientId:ko.observable(),users:_.map(e.users||[],function(e){return{selected:ko.observable(!1),value:ko.observable(e)}}),userRoles:_.map(e.userRoles||[],function(e){return{selected:ko.observable(!1),value:ko.observable(e)}}),viewOnlyUsers:_.map(e.users||[],function(e){return{selected:ko.observable(!1),value:ko.observable(e)}}),viewOnlyUserRoles:_.map(e.userRoles||[],function(e){return{selected:ko.observable(!1),value:ko.observable(e)}}),getAsList:function(e){var r="";return _.forEach(e,function(e){e.selected()&&(r+=(r?",":"")+e.value())}),r},setupList:function(e,r){_.forEach(e,function(e){0<=r.indexOf(e.value())?e.selected(!0):e.selected(!1)})}}},reportViewModel=function(l){var d=this;(l=l||{}).userSettings=l.userSettings||{},l.userId=l.userSettings.currentUserId||"",l.users=l.userSettings.users,l.userRoles=l.userSettings.userRoles,d.currentUserId=l.userSettings.userId,d.currentUserRole=(l.userSettings.currentUserRoles||[]).join(),d.currentUserName=l.userSettings.currentUserName,d.allowAdmin=ko.observable(l.userSettings.allowAdminMode),d.ReportName=ko.observable(),d.ReportType=ko.observable("List"),d.ReportDescription=ko.observable(),d.FolderID=ko.observable(),d.ReportID=ko.observable(),d.Tables=ko.observableArray([]),d.SelectedTable=ko.observable(),d.ChooseFields=ko.observableArray([]),d.ChosenFields=ko.observableArray([]),d.SelectedFields=ko.observableArray([]),d.SelectFields=ko.observableArray([]),d.SelectedField=ko.observable(),d.AdditionalSeries=ko.observableArray([]),d.IncludeSubTotal=ko.observable(!1),d.ShowUniqueRecords=ko.observable(!1),d.AggregateReport=ko.observable(!1),d.SortByField=ko.observable(),d.FilterGroups=ko.observableArray(),d.FilterGroups.subscribe(function(e){e&&0==e.length&&d.FilterGroups.push(new filterGroupViewModel({isRoot:!0,parent:d,options:l}))}),d.FilterGroups([]),d.SaveReport=ko.observable(!0),d.ShowDataWithGraph=ko.observable(!0),d.ShowOnDashboard=ko.observable(!1),d.ReportMode=ko.observable(l.reportMode||"start"),d.Folders=ko.observableArray(),d.SavedReports=ko.observableArray([]),d.SelectedFolder=ko.observable(null),d.CanSaveReports=ko.observable(!0),d.CanManageFolders=ko.observable(!0),d.CanEdit=ko.observable(!0),d.ReportResult=ko.observable({HasError:ko.observable(!1),ReportDebug:ko.observable(!1),Exception:ko.observable(),Warnings:ko.observable(),ReportSql:ko.observable(),ReportData:ko.observable(null)}),d.pager=new pagerViewModel,d.currentSql=ko.observable(),d.currentConnectKey=ko.observable(),d.adminMode=ko.observable(!1),d.x=ko.observable(0),d.y=ko.observable(0),d.width=ko.observable(3),d.height=ko.observable(2),d.adminMode.subscribe(function(e){d.LoadAllSavedReports(),e?(d._cansavereports=d.CanSaveReports(),d.SaveReport(!0),d.CanSaveReports(!0)):d.CanSaveReports(d._cansavereports)}),d.manageAccess=manageAccess(l),d.pager.currentPage.subscribe(function(){d.ExecuteReportQuery(d.currentSql(),d.currentConnectKey())}),d.createNewReport=function(){d.clearReport(),d.ReportMode("generate")},d.ReportType.subscribe(function(e){"List"==e?d.AggregateReport(!1):d.AggregateReport(!0)}),d.setReportType=function(e){d.ReportType(e)},d.cancelCreateReport=function(){bootbox.confirm("Are you sure you would like to cancel editing this Report?",function(e){e&&(d.clearReport(),l.reportWizard.modal("hide"),d.ReportMode("start"))})},d.FlyFilters=ko.computed(function(){var o=[];return $.each(d.FilterGroups(),function(e,r){$.each(r.Filters(),function(e,r){r.IsFilterOnFly&&o.push(r)})}),o}),d.enabledFields=ko.computed(function(){return _.filter(d.SelectedFields(),function(e){return!e.disabled()})}),d.scheduleBuilder=new scheduleBuilder,d.ManageFolder={FolderName:ko.observable(),IsNew:ko.observable(!1),newFolder:function(){d.ManageFolder.IsNew(!0),d.ManageFolder.FolderName(""),$("#folderModal").modal("show")},editFolder:function(){null!=d.SelectedFolder()?0!=d.SelectedFolder().Id?(d.ManageFolder.IsNew(!1),d.ManageFolder.FolderName(d.SelectedFolder().FolderName),$("#folderModal").modal("show")):toastr.error("Cannot edit Default folder"):toastr.error("Please choose a folder first")},saveFolder:function(){if(""!=d.ManageFolder.FolderName()){var r=d.ManageFolder.IsNew()?0:d.SelectedFolder().Id;if(0!=_.filter(d.Folders(),function(e){return e.FolderName.toLowerCase()==d.ManageFolder.FolderName().toLowerCase()&&(0==r||0!=r&&e.Id!=r)}).length)return toastr.error("Folder name is already in use, please choose a different Folder Name"),!1;ajaxcall({url:l.apiUrl,data:{method:"/ReportApi/SaveFolder",model:JSON.stringify({folderId:r,folderName:d.ManageFolder.FolderName()})}}).done(function(e){if(e.d&&(e=e.d),d.ManageFolder.IsNew())d.Folders.push({Id:e,FolderName:d.ManageFolder.FolderName()});else{var r=d.SelectedFolder();d.Folders.remove(d.SelectedFolder()),r.FolderName=d.ManageFolder.FolderName(),d.Folders.push(r)}$("#folderModal").modal("hide")})}else toastr.error("Please enter a Folder Name")},deleteFolder:function(){null!=d.SelectedFolder()?0!=d.SelectedFolder().Id?bootbox.confirm("Are you sure you want to delete this Folder?\n\nWARNING: Deleting a folder will delete all reports and this action cannot be undone.",function(e){e&&ajaxcall({url:l.apiUrl,data:{method:"/ReportApi/DeleteFolder",model:JSON.stringify({folderId:d.SelectedFolder().Id})}}).done(function(){d.Folders.remove(d.SelectedFolder()),d.SelectedFolder(null)})}):toastr.error("Cannot delete Default folder"):toastr.error("Please choose a folder first")}},d.reportsInFolder=ko.computed(function(){return null==d.SelectedFolder()?[]:_.filter(d.SavedReports(),function(e){return e.folderId==d.SelectedFolder().Id})}),d.clearReport=function(){d.ReportName(""),d.ReportDescription(""),d.ReportType("List"),d.FolderID(null==d.SelectedFolder()?0:d.SelectedFolder().Id),d.ChosenFields([]),d.SelectedFields([]),d.SelectFields([]),d.SelectedField(null),d.IncludeSubTotal(!1),d.ShowUniqueRecords(!1),d.AggregateReport(!1),d.SortByField(null),d.FilterGroups([]),d.ReportID(0),d.SaveReport(d.CanSaveReports()),d.scheduleBuilder.clear()},d.SelectedTable.subscribe(function(t){null!=t?ajaxcall({url:l.apiUrl,data:{method:"/ReportApi/GetFields",model:JSON.stringify({tableId:t.tableId,includeDoNotDisplay:!1})}}).done(function(e){e.d&&(e=e.d);var r=_.map(e,function(r,e){var o=_.filter(d.SelectedFields(),function(e){return e.fieldId==r.fieldId});return 0<o.length?o[0]:(r.tableName=t.tableName,d.setupField(r))});d.ChooseFields(r)}):d.ChooseFields([])}),d.MoveChosenFields=function(){$.each(d.ChosenFields(),function(e,r){0<_.filter(d.SelectedFields(),function(e){return e.fieldId==r.fieldId}).length?toastr.error(r.fieldName+" is already Selected"):d.SelectedFields.push(r)})},d.MoveAllFields=function(){$.each(d.ChooseFields(),function(e,r){0===_.filter(d.SelectedFields(),function(e){return e.fieldId==r.fieldId}).length&&d.SelectedFields.push(r)})},d.RemoveSelectedFields=function(){$.each(d.ChooseFields(),function(e,r){d.SelectedFields.remove(r)})},d.isFormulaField=ko.observable(!1),d.formulaFields=ko.observableArray([]),d.formulaFieldLabel=ko.observable(""),d.formulaDataFormat=ko.observable(""),d.formulaOnlyHasDateFields=ko.computed(function(){var e=d.formulaFields();if(e.length<=0)return!1;var o=!0;return $.each(e,function(e,r){if(!r.setupFormula.isParenthesesStart()&&!r.setupFormula.isParenthesesEnd()&&!r.setupFormula.isConstantValue()&&r.fieldType&&r.fieldType.indexOf("Date")<0)return o=!1}),o}),d.getEmptyFormulaField=function(){return{tableName:"Custom",fieldName:d.formulaFieldLabel()||"Custom",fieldFormat:d.formulaDataFormat()||"String",fieldType:"Custom",aggregateFunction:"",filterOnFly:!1,disabled:!1,groupInGraph:!1,hideInDetail:!1,fieldAggregate:["Group","Count"],fieldAggregateWithDrilldown:["Group","Count"],isFormulaField:!0,hasForeignKey:!1,fieldFilter:["=","<>",">=",">","<","<="],formulaItems:d.formulaFields()}},d.selectedFieldsCanFilter=ko.computed(function(){return _.filter(d.SelectedFields(),function(e){return!e.isFormulaField()})}),d.clearFormulaField=function(){d.formulaFields([]),d.formulaFieldLabel(""),d.formulaDataFormat("String")},d.isFormulaField.subscribe(function(){d.clearFormulaField()}),d.saveFormulaField=function(){if(0!=d.formulaFields().length)if(d.validateReport()){var e=d.getEmptyFormulaField();d.SelectedFields.push(d.setupField(e)),d.clearFormulaField(),d.isFormulaField(!1)}else toastr.error("Please correct validation issues");else toastr.error("Please select some items for the Custom Field")},d.showFormulaOperation=function(e){var r=d.formulaFields().length;return!(r<=1||e==r-1)&&(!d.formulaFields()[e+1].setupFormula.isParenthesesEnd()&&!d.formulaFields()[e].setupFormula.isParenthesesStart())},d.addFormulaParentheses=function(){if(!(d.formulaFields().length<=0||d.formulaFields()[0].setupFormula.isParenthesesStart()&&d.formulaFields()[d.formulaFields().length-1].setupFormula.isParenthesesEnd())){var e=d.getEmptyFormulaField(),r=d.setupField(Object.assign({},e)),o=d.setupField(Object.assign({},e));r.setupFormula.isParenthesesStart(!0),o.setupFormula.isParenthesesEnd(!0),d.formulaFields.splice(0,0,r),d.formulaFields.push(o)}},d.addFormulaConstantValue=function(){var e=d.getEmptyFormulaField(),r=d.setupField(Object.assign({},e));r.setupFormula.isConstantValue(!0),d.formulaFields.push(r)},d.isFieldValidForYAxis=function(e,r){return!(0<e&&"Bar"==d.ReportType()&&["Int","Double","Money"].indexOf(r)<0)},d.isChart=ko.computed(function(){return["List","Summary"].indexOf(d.ReportType())<0}),d.isFieldValidForSubGroup=function(e,r){return!(0<e&&["Int","Double","Money"].indexOf(r)<0)},d.canDrilldown=ko.computed(function(){return["List"].indexOf(d.ReportType())<0}),d.dateFields=ko.computed(function(){return _.filter(d.SelectedFields(),function(e){return"DateTime"==e.fieldType})}),d.canAddSeries=ko.computed(function(){var e=0<d.dateFields().length&&0<=["Bar","Line"].indexOf(d.ReportType()),r=0<_.filter(d.FilterGroups(),function(e){return 0<_.filter(e.Filters(),function(e){return"range"==e.Operator()&&e.Value()&&0==e.Value().indexOf("This")}).length}).length;return e&&r}),d.canAddSeries.subscribe(function(e){e||d.AdditionalSeries([])}),d.AddSeries=function(e){e=e||{};var o=ko.observable();e.FieldId?o(d.FindField(e.FieldId)):o(d.dateFields()[0]);var r=ko.observableArray([]);function t(e){r("This Year"==e?["Last Year","2 Years ago","3 Years ago","4 Years ago","5 Years ago"]:"This Month"==e?["Last Month","2 Months ago","3 Months ago","4 Months ago","5 Months ago"]:"This Week"==e?["Last Week","2 Weeks ago","3 Weeks ago","4 Weeks ago","5 Weeks ago"]:[])}$.each(d.FilterGroups,function(e,r){$.each(r.Filters(),function(e,r){if(r.Field().FieldId==o().FieldId)return t(r.Value()),r.Value.subscribe(function(e){t(e)}),!1})}),d.AdditionalSeries.push({Field:o,Operator:ko.observable("Range"),Value:ko.observable(e.Value),Range:r})},d.canMoveUp=function(){return 1==d.SelectFields().length&&1<=d.SelectedFields.indexOf(d.SelectFields()[0])},d.canMoveDown=function(){return 1==d.SelectFields().length&&d.SelectedFields.indexOf(d.SelectFields()[0])<d.SelectedFields().length-1},d.MoveUp=function(){if(d.canMoveUp()){var e=d.SelectFields()[0],r=d.SelectedFields.indexOf(e);if(1<=r){var o=d.SelectedFields();d.SelectedFields.splice(r-1,2,o[r],o[r-1])}}},d.MoveDown=function(){if(d.canMoveDown()){var e=d.SelectFields()[0],r=d.SelectedFields.indexOf(e),o=d.SelectedFields();r<o.length-1&&d.SelectedFields.splice(r,2,o[r+1],o[r])}},d.RemoveField=function(e){d.SelectedFields.remove(e)},d.RemoveSeries=function(e){d.AdditionalSeries.remove(e)},d.FindField=function(r){return _.filter(d.SelectedFields(),function(e){return e.fieldId==r})[0]},d.SaveWithoutRun=function(){d.RunReport(!0)},d.BuildFilterData=function(e){var r=[];return $.each(e,function(e,t){var a=[];$.each(t.Filters(),function(e,r){var o=r.Apply()&&r.IsFilterOnFly||!r.IsFilterOnFly?{SavedReportId:d.ReportID(),FieldId:r.Field().fieldId,AndOr:0==e?t.AndOr():r.AndOr(),Operator:r.Operator(),Value1:Array.isArray(r.Value())&&"in"==r.Operator()?r.Value().join(","):0<=r.Operator().indexOf("blank")?"blank":r.Value(),Value2:r.Value2(),Filters:0==e?d.BuildFilterData(t.FilterGroups()):[]}:null;null==o||o.Value1||o.Value2||(o=null),o&&a.push(o)}),r.push({SavedReportId:d.ReportID(),isRoot:t.isRoot,AndOr:t.AndOr(),Filters:a})}),r},d.BuildReportData=function(e){e=e||[];var r=d.BuildFilterData(d.FilterGroups());return{ReportID:d.ReportID(),ReportName:d.ReportName(),ReportDescription:d.ReportDescription(),FolderID:d.FolderID(),SelectedFieldIDs:_.map(d.SelectedFields(),function(e){return e.fieldId}),Filters:r,Series:_.map(d.AdditionalSeries(),function(e,r){return{SavedReportId:d.ReportID(),FieldId:e.Field().fieldId,Operator:e.Operator(),Value:e.Value()}}),IncludeSubTotals:d.IncludeSubTotal(),ShowUniqueRecords:d.ShowUniqueRecords(),IsAggregateReport:!(0<e.length)&&d.AggregateReport(),ShowDataWithGraph:d.ShowDataWithGraph(),ShowOnDashboard:d.ShowOnDashboard(),SortBy:d.SortByField(),ReportType:d.ReportType(),GroupFunctionList:_.map(d.SelectedFields(),function(e){return{FieldID:e.fieldId,GroupFunc:e.selectedAggregate(),FilterOnFly:e.filterOnFly(),Disabled:e.disabled(),GroupInGraph:e.groupInGraph(),HideInDetail:e.hideInDetail(),IsCustom:e.isFormulaField(),CustomLabel:e.fieldName,DataFormat:e.fieldFormat,CustomFieldDetails:_.map(e.formulaItems(),function(e){return{FieldId:e.fieldId(),IsParenthesesStart:e.isParenthesesStart()||!1,IsParenthesesEnd:e.isParenthesesEnd()||!1,Operation:e.formulaOperation(),ConstantValue:e.constantValue()}})}}),Schedule:d.scheduleBuilder.toJs(),DrillDownRow:e,UserId:d.manageAccess.getAsList(d.manageAccess.users),ViewOnlyUserId:d.manageAccess.getAsList(d.manageAccess.viewOnlyUsers),UserRoles:d.manageAccess.getAsList(d.manageAccess.userRoles),ViewOnlyUserRoles:d.manageAccess.getAsList(d.manageAccess.viewOnlyUserRoles),DataFilters:l.dataFilters}},d.RunReport=function(r){r=!0===r,d.validateReport()?ajaxcall({url:l.runReportApiUrl,type:"POST",data:JSON.stringify({method:"/ReportApi/RunReport",SaveReport:!!d.CanSaveReports()&&d.SaveReport(),ReportJson:JSON.stringify(d.BuildReportData()),adminMode:d.adminMode()})}).done(function(e){e.d&&(e=e.d),d.ReportID(e.reportId),d.SaveReport()&&(toastr.success("Report Saved"),r&&d.LoadAllSavedReports()),r||("execute"==d.ReportMode()||"dashboard"==d.ReportMode()?d.ExecuteReportQuery(e.sql,e.connectKey):redirectToReport(l.runReportUrl,{reportId:e.reportId,reportName:d.ReportName(),reportDescription:d.ReportDescription(),includeSubTotal:d.IncludeSubTotal(),showUniqueRecords:d.ShowUniqueRecords(),aggregateReport:d.AggregateReport(),showDataWithGraph:d.ShowDataWithGraph(),reportSql:e.sql,connectKey:e.connectKey,reportFilter:JSON.stringify(_.map(d.FlyFilters(),function(e){return ko.toJS(e)})),reportType:d.ReportType(),selectedFolder:null!=d.SelectedFolder()?d.SelectedFolder().Id:0}))}):toastr.error("Please correct validation issues")},d.ExecuteReportQuery=function(o,t){o&&t&&ajaxcall({url:l.execReportUrl,type:"POST",data:JSON.stringify({reportSql:o,connectKey:t,reportType:d.ReportType(),pageNumber:d.pager.currentPage(),pageSize:d.pager.pageSize(),sortBy:d.pager.sortColumn()||"",desc:d.pager.sortDescending()||!1})}).done(function(e){e.d&&(e=e.d);var r=d.ReportResult();r.HasError(e.HasError),r.Exception(e.Exception),r.Warnings(e.Warnings),r.ReportDebug(e.ReportDebug),r.ReportSql(e.ReportSql),e.ReportData.IsDrillDown=ko.observable(!1),$.each(e.ReportData.Rows,function(e,r){r.DrillDownData=ko.observable(null),r.pager=new pagerViewModel({pageSize:10}),r.sql="",r.connectKey="",r.changeSort=function(e){return r.pager.changeSort(e),r.execute(),!1},r.isExpanded=ko.observable(!1),r.execute=function(){""!=r.sql&&ajaxcall({url:l.execReportUrl,type:"POST",data:JSON.stringify({reportSql:r.sql,connectKey:r.connectKey,reportType:"List",pageNumber:r.pager.currentPage(),pageSize:r.pager.pageSize(),sortBy:r.pager.sortColumn()||"",desc:r.pager.sortDescending()||!1})}).done(function(e){e.d&&(e=e.d),e.ReportData.IsDrillDown=ko.observable(!0),r.DrillDownData(e.ReportData),r.pager.totalRecords(e.Pager.TotalRecords),r.pager.pages(e.Pager.TotalPages)})},r.expand=function(){ajaxcall({url:l.runReportApiUrl,type:"POST",data:JSON.stringify({method:"/ReportApi/RunDrillDownReport",SaveReport:!1,ReportJson:JSON.stringify(d.BuildReportData(r.Items)),adminMode:d.adminMode()})}).done(function(e){e.d&&(e=e.d),r.sql=e.sql,r.connectKey=e.connectKey,r.execute()}),r.isExpanded(!0)},r.pager.currentPage.subscribe(function(){r.execute()}),r.collapse=function(){r.isExpanded(!1)},r.toggle=function(){r.isExpanded()?r.collapse():r.expand()}}),r.ReportData(e.ReportData),d.pager.totalRecords(e.Pager.TotalRecords),d.pager.pages(e.Pager.TotalPages),d.currentSql(o),d.currentConnectKey(t),e.Warnings&&toastr.info("Note: "+e.Warnings),d.isChart()&&(google.charts.load("current",{packages:["corechart"]}),google.charts.setOnLoadCallback(d.DrawChart))})},d.ExpandAll=function(){$.each(d.ReportResult().ReportData().Rows,function(e,r){r.expand()})},d.CollapseAll=function(){$.each(d.ReportResult().ReportData().Rows,function(e,r){r.collapse()})},d.DrawChart=function(){if(d.isChart()){var e=d.ReportResult().ReportData(),a=new google.visualization.DataTable,s=[],l=[];$.each(e.Columns,function(e,r){var o=d.SelectedFields()[e];0==e?a.addColumn(r.IsNumeric?"number":"string",r.ColumnName):o.groupInGraph()?s.push({index:e,column:r.ColumnName}):r.IsNumeric&&l.push({index:e,column:r.ColumnName})}),0==s.length&&$.each(e.Columns,function(e,r){0<e&&r.IsNumeric&&a.addColumn(r.IsNumeric?"number":"string",r.ColumnName)});var n=[],i=[];$.each(e.Rows,function(e,r){var t=[];$.each(r.Items,function(r,o){if(0==r)0<s.length&&0<(t=_.filter(n,function(e){return e[0]==o.Value})).length?(n=n.filter(function(e){return e[0]!=o.Value}),t=t[0]):t.push(o.Column.IsNumeric?parseInt(o.Value):o.Value);else if(0<s.length){1==_.filter(s,function(e){return e.index==r}).length?0==_.filter(i,function(e){return e==o.Value}).length&&(i.push(o.Value),$.each(l,function(e,r){a.addColumn("number",o.Value+(0==e?"":"-"+e))})):o.Column.IsNumeric&&t.push(o.Column.IsNumeric?parseInt(o.Value):o.Value)}else o.Column.IsNumeric&&t.push(o.Column.IsNumeric?parseInt(o.Value):o.Value)}),n.push(t)}),$.each(n,function(e,r){if(r.length!=a.getNumberOfColumns())for(var o=0;o<=a.getNumberOfColumns()-r.length;o++)r.push(0)}),a.addRows(n);var r={title:d.ReportName(),animation:{startup:!0,duration:1e3,easing:"out"}},o=document.getElementById("chart_div_"+d.ReportID()),t=null;"Pie"==d.ReportType()&&(t=new google.visualization.PieChart(o)),"Bar"==d.ReportType()&&(t=new google.visualization.ColumnChart(o)),"Line"==d.ReportType()&&(t=new google.visualization.LineChart(o)),"Map"==d.ReportType()&&(t=new google.visualization.GeoChart(o)),t.draw(a,r)}},d.loadFolders=function(o){ajaxcall({url:l.apiUrl,data:{method:"/ReportApi/GetFolders",model:JSON.stringify({adminMode:d.adminMode()})}}).done(function(e){if(e.d&&(e=e.d),d.Folders(e),d.SelectedFolder(null),o){var r=_.filter(e,function(e){return e.Id==o});0<r.length&&d.SelectedFolder(r[0])}})},d.setupField=function(e){e.selectedFieldName=e.tableName+" > "+e.fieldName,e.selectedAggregate=ko.observable(e.aggregateFunction),e.filterOnFly=ko.observable(e.filterOnFly),e.disabled=ko.observable(e.disabled),e.groupInGraph=ko.observable(e.groupInGraph),e.hideInDetail=ko.observable(e.hideInDetail),e.fieldAggregateWithDrilldown=e.fieldAggregate.concat("Only in Detail"),e.isFormulaField=ko.observable(e.isFormulaField);var o=[];return $.each(e.formulaItems||[],function(e,r){o.push(new formulaFieldViewModel({fieldId:r.fieldId||0,isParenthesesStart:r.setupFormula?r.setupFormula.isParenthesesStart():r.isParenthesesStart,isParenthesesEnd:r.setupFormula?r.setupFormula.isParenthesesEnd():r.isParenthesesEnd,formulaOperation:r.setupFormula?r.setupFormula.formulaOperation():r.formulaOperation,constantValue:r.setupFormula?r.setupFormula.constantValue():r.constantValue}))}),e.formulaItems=ko.observableArray(o),e.setupFormula=new formulaFieldViewModel,e},d.LoadReport=function(e,o){return ajaxcall({url:l.apiUrl,data:{method:"/ReportApi/LoadReport",model:JSON.stringify({reportId:e})}}).done(function(e){e.d&&(e=e.d),d.ReportID(e.ReportID),d.ReportType(e.ReportType),d.ReportName(e.ReportName),d.ReportDescription(e.ReportDescription),d.FolderID(e.FolderID),$.each(e.SelectedFields,function(e,r){r=d.setupField(r)}),d.SelectedFields(e.SelectedFields),d.ChosenFields([]),d.SelectFields([]),d.SelectedField(null),d.manageAccess.setupList(d.manageAccess.users,e.UserId||""),d.manageAccess.setupList(d.manageAccess.userRoles,e.UserRoles||""),d.manageAccess.setupList(d.manageAccess.viewOnlyUserRoles,e.ViewOnlyUserRoles||""),d.manageAccess.setupList(d.manageAccess.viewOnlyUsers,e.ViewOnlyUserId||""),d.IncludeSubTotal(e.IncludeSubTotals),d.ShowUniqueRecords(e.ShowUniqueRecords),d.AggregateReport(e.IsAggregateReport),d.ShowDataWithGraph(e.ShowDataWithGraph),d.ShowOnDashboard(e.ShowOnDashboard),d.SortByField(e.SortBy),d.CanEdit((!l.clientId||e.ClientId==l.clientId)&&(!l.userId||e.UserId==l.userId)||d.adminMode()),d.FilterGroups([]),d.AdditionalSeries([]),d.scheduleBuilder.fromJs(e.Schedule);var a=[];function s(e,t){e&&0!=e.length&&$.each(e,function(e,r){if(r.FieldId){if(a.indexOf(r.FieldId)<0){var o=0<_.filter(d.SelectedFields(),function(e){return 1==e.filterOnFly()&&e.fieldId==r.FieldId}).length;o&&a.push({fieldId:r.FieldId}),null==t&&(t=d.FilterGroups()[0]),t.AddFilter(r,o)}}else t=null==t?d.FilterGroups()[0]:t.AddFilterGroup({AndOr:r.AndOr});s(r.Filters,t)})}if(1==o){if(l.reportFilter&&"[]"!=l.reportFilter){var r=JSON.parse(l.reportFilter);$.each(r,function(e,r){var o=_.filter(a,function(e){return e.fieldId==r.Field.fieldId});0<o.length&&(r.FieldId=r.Field.fieldId,r.Value1=r.Value,a.push(o[0]),d.FilterGroups()[0].AddFilter(r,!0))})}s(e.Filters)}else s(e.Filters);$.each(e.Series,function(e,r){d.AddSeries(r)}),d.SaveReport(!o&&d.CanEdit()),"execute"!=d.ReportMode()&&"dashboard"!=d.ReportMode()||d.ExecuteReportQuery(l.reportSql,l.reportConnect)})},d.LoadAllSavedReports=function(){ajaxcall({url:l.apiUrl,data:{method:"/ReportApi/GetSavedReports",model:JSON.stringify({adminMode:d.adminMode()})}}).done(function(e){e.d&&(e=e.d),$.each(e,function(e,r){r.runMode=!1,r.openReport=function(){return d.LoadReport(r.reportId).done(function(){r.runMode?(d.SaveReport(!1),d.RunReport(),r.runMode=!1):d.ReportMode("generate")})},r.copyReport=function(){r.openReport().done(function(){d.ReportID(0),d.ReportName("Copy of "+d.ReportName()),d.CanEdit(!0),d.SaveReport(!0)})},r.runReport=function(){r.runMode=!0,r.openReport()},r.deleteReport=function(){bootbox.confirm("Are you sure you would like to Delete this Report?",function(e){e&&ajaxcall({url:l.apiUrl,data:{method:"/ReportApi/DeleteReport",model:JSON.stringify({reportId:r.reportId})}}).done(function(){d.SavedReports.remove(r)})})},0<l.reportId&&r.reportId==l.reportId&&(r.openReport(),l.reportWizard.modal("show"))}),d.SavedReports(e)})},"dashboard"!=d.ReportMode()&&(d.LoadAllSavedReports(),ajaxcall({url:l.apiUrl,data:{method:"/ReportApi/CanSaveReports",model:"{}"}}).done(function(e){e.d&&(e=e.d),e=e||{allowUsersToCreateReports:!0,allowUsersToManageFolders:!0},d.CanSaveReports(e.allowUsersToCreateReports),d.CanManageFolders(e.allowUsersToManageFolders)})),d.changeSort=function(e){return d.pager.changeSort(e),d.ExecuteReportQuery(d.currentSql(),d.currentConnectKey()),!1},d.isInputValid=function(e){return(null==$(e).attr("data-notempty")||0!=$(e).children("option").length)&&(e.validity?e.validity.valid:null==$(e).attr("required")||""!=$(e).val())},d.validateReport=function(){if(null!=l.reportWizard){var e=l.reportWizard.find("input,select"),r=!0;$(".form-group").removeClass("has-error");for(var o=0;o<e.length;o++)d.isInputValid(e[o])||(r=!1,$(e[o]).closest(".form-group").addClass("has-error"));return r}},d.loadTables=function(){ajaxcall({url:l.apiUrl,data:{method:"/ReportApi/GetTables",model:JSON.stringify({adminMode:d.adminMode()})}}).done(function(e){e.d&&(e=e.d),d.Tables(e)})},d.init=function(e,r){r?$("#noaccountModal").modal("show"):(d.loadFolders(e),d.loadTables())}},dashboardViewModel=function(o){var a=this;a.dashboards=ko.observableArray(o.dashboards||[]),a.adminMode=ko.observable(!1),a.currentUserId=o.userId,a.currentUserRole=(o.currentUserRole||[]).join(),a.reportsAndFolders=ko.observableArray([]),a.allowAdmin=ko.observable(o.allowAdmin);var e=0<o.dashboardId?_.find(a.dashboards(),{id:o.dashboardId})||{name:"",description:""}:0<a.dashboards().length?a.dashboards()[0]:{name:"",description:""};a.dashboard={Id:ko.observable(e.id),Name:ko.observable(e.name),Description:ko.observable(e.description),manageAccess:manageAccess(o)},a.currentDashboard=ko.observable(e),a.selectDashboard=ko.observable(e.id),a.selectDashboard.subscribe(function(e){e!=a.currentDashboard().id&&(window.location=window.location.href.split("?")[0]+"?id="+e)}),a.newDashboard=function(){a.dashboard.Id(0),a.dashboard.Name(""),a.dashboard.Description(""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.users,""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.userRoles,""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.viewOnlyUserRoles,""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.viewOnlyUsers,""),_.forEach(a.reportsAndFolders(),function(e){_.forEach(e.reports,function(e){e.selected(!1)})})},a.editDashboard=function(){a.dashboard.Id(a.currentDashboard().id),a.dashboard.Name(a.currentDashboard().name),a.dashboard.Description(a.currentDashboard().description),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.users,a.currentDashboard().userId||""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.userRoles,a.currentDashboard().userRoles||""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.viewOnlyUserRoles,a.currentDashboard().viewOnlyUserRoles||""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.viewOnlyUsers,a.currentDashboard().viewOnlyUserId||"");var r=(a.currentDashboard().selectedReports||"").split(",");_.forEach(a.reportsAndFolders(),function(e){_.forEach(e.reports,function(e){e.selected(0<=r.indexOf(e.reportId.toString()))})})},a.saveDashboard=function(){if($(".form-group").removeClass("has-error"),!a.dashboard.Name())return $("#add-dash-name").closest(".form-group").addClass("has-error"),!1;var r="";_.forEach(a.reportsAndFolders(),function(e){_.forEach(e.reports,function(e){e.selected()&&(r+=(r?",":"")+e.reportId)})});var e={id:a.dashboard.Id()||0,name:a.dashboard.Name(),description:a.dashboard.Description(),selectedReports:r,userIdAccess:a.dashboard.manageAccess.getAsList(a.dashboard.manageAccess.users),viewOnlyUserId:a.dashboard.manageAccess.getAsList(a.dashboard.manageAccess.viewOnlyUsers),userRolesAccess:a.dashboard.manageAccess.getAsList(a.dashboard.manageAccess.userRoles),viewOnlyUserRoles:a.dashboard.manageAccess.getAsList(a.dashboard.manageAccess.viewOnlyUserRoles),adminMode:a.adminMode()};return ajaxcall({url:o.apiUrl,data:{method:"/ReportApi/SaveDashboard",model:JSON.stringify(e)}}).done(function(e){e.d&&(e=e.d),toastr.success("Dashboard saved successfully"),setTimeout(function(){window.location=window.location.href.split("?")[0]+"?id="+e.id},500)}),!0},a.deleteDashboard=function(){bootbox.confirm("Are you sure you would like to Delete this Dashboard?",function(e){e&&ajaxcall({url:o.apiUrl,data:{method:"/ReportApi/DeleteDashboard",model:JSON.stringify({id:a.currentDashboard().id,adminMode:a.adminMode()})}}).done(function(e){toastr.success("Dashboard deleted successfully"),setTimeout(function(){window.location=window.location.href.split("?")[0]},500)})})},a.reports=ko.observableArray([]);var t=0;_.forEach(o.reports,function(e){var r=new reportViewModel({runReportUrl:o.runReportUrl,execReportUrl:o.execReportUrl,reportWizard:o.reportWizard,lookupListUrl:o.lookupListUrl,runReportApiUrl:o.runReportApiUrl,apiUrl:o.apiUrl,reportFilter:e.reportFilter,reportMode:"dashboard",reportSql:e.reportSql,reportId:e.reportId,reportConnect:e.connectKey,users:o.users,userRoles:o.userRoles});r.x=ko.observable(e.x),r.y=ko.observable(e.y),r.width=ko.observable(e.width),r.height=ko.observable(e.height),r.panelStyle="panel-"+(0==t?"default":1==t?"info":2==t?"warning":"danger"),t=3==t?0:t+1,a.reports.push(r),r.LoadReport(e.reportId,!0),r.showFlyFilters=ko.observable(!1),r.toggleFlyFilters=function(){r.showFlyFilters(!r.showFlyFilters())}}),a.drawChart=function(){_.forEach(a.reports(),function(e){e.DrawChart()})},a.updatePosition=function(e){ajaxcall({url:o.apiUrl,noBlocking:!0,data:{method:"/ReportApi/UpdateDashboardReportPosition",model:JSON.stringify({x:e.x,y:e.y,width:e.width,height:e.height,dashboardId:a.currentDashboard().id,reportId:e.id})}})},a.init=function(){return $.when(ajaxcall({url:o.apiUrl,data:{method:"/ReportApi/GetSavedReports",model:JSON.stringify({adminMode:a.adminMode()})}}),ajaxcall({url:o.apiUrl,data:{method:"/ReportApi/GetFolders",model:JSON.stringify({adminMode:a.adminMode()})}})).done(function(o,e){var t=[];e[0].d&&(e[0]=e[0].d),o[0].d&&(o[0]=o[0].d),_.forEach(e[0],function(e){var r=_.filter(o[0],{folderId:e.Id});t.push({folderId:e.Id,folder:e.FolderName,reports:_.map(r,function(e){return{reportId:e.reportId,reportName:e.reportName,reportDescription:e.reportDescription,reportType:e.reportType,selected:ko.observable(!1)}})})}),a.reportsAndFolders(t)})},a.adminMode.subscribe(function(e){a.init()})};